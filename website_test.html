<!doctype html>

<html>

<head>
    <title>Tutorial 1: Getting Started</title>
    <script src="cytoscape.min.js"></script>


    <script src="https://unpkg.com/numeric/numeric-1.2.6.js"></script>
    <script src="https://unpkg.com/layout-base/layout-base.js"></script>
    <script src="https://unpkg.com/cose-base/cose-base.js"></script>
    <script src="cytoscape-cxtmenu.js"></script>

    <link rel="stylesheet" href="jquery-ui-1.12.1.custom/jquery-ui.min.css">
    <script src="jquery-ui-1.12.1.custom/external/jquery/jquery.js"></script>
    <script src="jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
</head>

<style>
    div.tabs
    {
        position: absolute;
        width: 90%;
        left: 5%;
        top: 77%;
    }

    div.leftSideBar
    {
        position: absolute;
        width: 18.5%;
        height: 73%;
        top: 1%;
    }

    div.leftSideBar.ui-tabs .ui-tabs-panel
    {
        padding: 1em 1.4em 1em 0;
        height: 85%;
        overflow-y: scroll;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none;  /* Internet Explorer 10+ */
    }

    div.leftSideBar .ui-tabs-panel::-webkit-scrollbar /* WebKit */
    {
        width: 0;
        height: 0;
    }

    div.rightSideBar
    {
        position: absolute;
        width: 18.5%;
        height: 73%;
        top: 1%;
        left: 80.5%;
    }

    div.rightSideBar.ui-tabs .ui-tabs-panel
    {
        padding: 1em 1.4em 1em 0;
        height: 85%;
        overflow-y: scroll;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none;  /* Internet Explorer 10+ */
    }

    div.rightSideBar .ui-tabs-panel::-webkit-scrollbar /* WebKit */
    {
        width: 0;
        height: 0;
    }

    .top
    {
        position: relative;
        height: 50%;
    }

    .bottom
    {
        position: relative;
        top: 54%;
        height: 46%;
    }

    .roundedCorners {
        position: relative;
        border-radius: 25px;
        background: #c9c9c9;
        padding: 10px;
        width: 100%;
        height: 100%;
    }

    body
    {
        background-color: #9e9e9e;
    }

    #cy
    {
        width: 60%;
        height: 75%;
        position: absolute;
        top: 0px;
        left: 20%;
        /*background-color: #9e9e9e ; */
        outline: 1px solid black;
    }

    div.table-scroll
    {
        position: absolute;
        margin-top: 20px;
        overflow-y: scroll;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none;  /* Internet Explorer 10+ */
    }
    div.table-scroll::-webkit-scrollbar /* WebKit */
    {
        width: 0;
        height: 0;
    }

    table.paleBlueRows
    {
        font-family: "Times New Roman", Times, serif;
        border: 0px solid #000000;
        width: 20%;
        height: 3%;
        text-align: center;
        border-collapse: collapse;
    }

    table.paleBlueRows td, table.paleBlueRows th
    {
        padding: 3px 2px;
        border: 2px solid #000000;
    }

    table.paleBlueRows tbody td
    {
        font-size: 13px;
        word-wrap: break-word;
    }

    table.paleBlueRows tr:nth-child(even)
    {
        background: #D0E4F5;
    }

    table.paleBlueRows th
    {
        font-size: 17px;
        font-weight: bold;
        color: #FFFFFF;
        text-align: center;
        background: #0B6FA4;
        width: 25%;
        word-wrap: break-word;
    }

    table.paleBlueRows th:nth-child(even)
    {
        background: #D0E4F5;
    }

    .loader {
        border: 16px solid #9e9e9e;
        border-radius: 50%;
        border-top: 16px solid white;
        border-right: 16px solid #9e9e9e;
        border-bottom: 16px solid white;
        top: 40%;
        left: 45%;
        position: absolute;
        width: 100px;
        height: 100px;
        -webkit-animation: spin 2s linear infinite;
        animation: spin 2s linear infinite;
        visibility: hidden;
        z-index: 100;
    }

    @-webkit-keyframes spin {
        0% { -webkit-transform: rotate(0deg); }
        100% { -webkit-transform: rotate(360deg); }
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

</style>

<body>

<param id="base_address" value="{{ base_addr }}">
<div class="loader" id="loader"></div>
<div class="tabs" id="tabs">
    <ul>
        <li><a href="#tabs-1">Search</a></li>
        <li><a href="#tabs-2">Query</a></li>
        <li><a href="#tabs-3">Download</a></li>
    </ul>
    <div id="tabs-1">
        Enter Node ID: <input type="text" id="nodeKeyText" name="nodeID" size="50">
        <select id="nodeTypeBox" onChange="showHide()">
            {% for key, value in schema.items %}
            <option value={{key}}>{{key}}</option>
            {% endfor %}
        </select>
        {% for key, value in schema.items %}
        <select id={{key}} hidden>
            {% for i in value %}
            <option value={{i}}>{{i}}</option>
            {% endfor %}
        </select>
        {% endfor %}
        Search Depth<select id="searchDepth">
        <option value="1" selected="selected">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
    </select>
        <input type="submit" id="getnode" value="get node" onclick="GetNode()">
    </div>
    <div id="tabs-2">
        Enter Query: <input type="text" id="queryText" name="query" size="50"><br>
        <input type="submit" value="execute query" onclick="ExecuteQuery()">
    </div>
    <div id="tabs-3">
        <input type="submit" value="Download Graph" onclick="DownloadGraph()">
        <input type="submit" value="Download Style" onclick="DownloadStyle()">
        <input type="submit" value="Show Image" onclick="DownloadImage()">
    </div>
</div>

<div class="leftSideBar" id="leftSideBar">
    <ul> <!-- don't delete ul's -->
    </ul>
</div>

<div class="rightSideBar" id="rightSideBar">

    <ul>
        <li><a href="#layoutTab">Layout</a></li>
        <li><a href="#filteringTab">Filtering</a></li>
        <li><a href="#legendTab">Legend</a></li>
    </ul>
    <div id="layoutTab">
        Layout type:
        <select id="layoutSelection">
            <option value="concentric">concentric</option>
            <option value="cose">cose</option>
            <option value="fcose">fcose</option>
            <option value="circle">circle</option>
            <option value="grid">grid</option>
        </select>
        <br>
        <br>
        <button id="toggleCenteringHighDegreeNodes">Toggle centering nodes with degree higher than:</button>
        <br>
        <input id="spinnerCenteringHighDegreeNodes" name="value">
        <br>
        <br>
        <input type="submit" value="run layout" onclick="RunLayout(cy)">
    </div>
    <div id="filteringTab">
        P-value threshold:<input id="pvalue" type="number" value=0.05>
        <br>
        <br>
        Max compounds per protein:<input id="topvalue" type="number" value=5>
        <br>
        <br>
        Max node count per node type: <input id="nodeTypeMaxCount" type="number" value=10>
        <br>
        <br>
        <input type="submit" value="filter nodes" onclick="FilterGraphNew()">
        <input id="revert" type="submit" value="revert filtering" onclick="revertFiltering()">
    </div>
    <div id="legendTab" class="table-scroll">
        <img src="disease.png" alt="Disease node" style="vertical-align:middle"> Disease
        <br>
        <img src="phenotype.png" alt="Phenotype node" style="vertical-align:middle"> Phenotype
        <br>
        <img src="gene.png" alt="Gene node" style="vertical-align:middle"> Gene
        <br>
        <img src="protein.png" alt="Protein node" style="vertical-align:middle"> Protein
        <br>
        <img src="interpro.png" alt="Interpro(Domain) node" style="vertical-align:middle"> Interpro(Domain)
        <br>
        <img src="geneOntology.png" alt="Gene Ontology node" style="vertical-align:middle"> Gene Ontology
        <br>
        <img src="pathway.png" alt="Pathway node" style="vertical-align:middle"> Pathway
        <br>
        <img src="drug.png" alt="Drug node" style="vertical-align:middle"> Drug
        <br>
        <img src="drugCandidate.png" alt="Drug Candidate(Compound) node" style="vertical-align:middle"> Drug Candidate (Compound)
        <br>
        <img src="mainNode.png" alt="Drug Candidate(Compound) node" style="vertical-align:middle"> Main Node
        <br>
        <img src="edgeCount.png" alt="Drug Candidate(Compound) node" style="vertical-align:middle"> Edge Count
        <br>
        <img src="edgeCountLoop.png" alt="Drug Candidate(Compound) node" style="vertical-align:middle"> Loop Edge Count
    </div>
</div>

<div id="cy"></div>
<script></script>



<script>

    //showHide();

    // template for dynamically adding tabs
    let tabTemplate = "<li><a href='#{href}'>#{label}</a></li>";

    //<!-- this executes jquery on tabs and other parts -->
    var spinner = $( "#spinnerCenteringHighDegreeNodes" ).spinner();
    spinner.spinner( "value", 20 );
    spinner.spinner( "option", "disabled", true );
    var leftSideBarTabs;//keep variable to dynamically add new tabs later
    var leftSideBarTabCount=1;//used for removing active tabs
    $( function() {
        $( "#tabs" ).tabs();
        leftSideBarTabs = $( "#leftSideBar" ).tabs();
        $("#rightSideBar").tabs();

        $( "#toggleCenteringHighDegreeNodes" ).on( "click", function() {
            if ( spinner.spinner( "option", "disabled" ) ) {
                spinner.spinner( "enable" );
            } else {
                spinner.spinner( "disable" );
            }
        });
    } );

    $(document).ready(function() {
        window.current = document.getElementById("nodeTypeBox").value;
        window.base_address = document.getElementById("base_address").value;
        console.log("BASE ADDR:" + base_address);
        window.flag = false;
        document.getElementById("pvalue").value = 0.05;
        topval = document.getElementById("topvalue").value = 5;
        window.MAX_COUNTS = {"Drug": 30,
            "Pathway": 30,
            "Gene": 30,
            "Disease": 30,
            "Phenotype": 30,
            "Intepro": 30,
            "GeneOntology": 30};
        window.filteredElements = {"elements": []};
        window.filteredNodeSet = new Set();
        showHide();
    });

    function clearFilteredElements() {
        filteredElements = {"elements": []};
        filteredNodeSet = new Set();
    }

    function addFilteredElement(ele) {
        filteredElements["elements"].push({"data": ele});
        filteredNodeSet.add(ele.id);
    }

    let checkForGraph = function() {
        try {
            cy.json()
        }
        catch(error) {
            alert("You have not searched for a graph yet!");
            return true;
        }
    }

    let DownloadGraph = function() {
        if (checkForGraph()) return null;
        let content = cy.json();
        let date = new Date();
        const filename = date.getDay() + '-' + date.getMonth() + '-' + date.getFullYear() + '-graph.txt';
        var blob = new Blob([JSON.stringify(content)], {type: 'text'});
        if(window.navigator.msSaveOrOpenBlob) {
            window.navigator.msSaveBlob(blob, filename);
        }
        else{
            var elem = window.document.createElement('a');
            elem.href = window.URL.createObjectURL(blob);
            elem.download = filename;
            document.body.appendChild(elem);
            elem.click();
            document.body.removeChild(elem);
        }
    }

    let DownloadStyle = function() {
        if (checkForGraph()) return null;
        let style = cy.style().json();
        let date = new Date();
        const filename = date.getDay() + '-' + date.getMonth() + '-' + date.getFullYear() + '-style.txt';
        var blob = new Blob([JSON.stringify(style)], {type: 'text'});
        if(window.navigator.msSaveOrOpenBlob) {
            window.navigator.msSaveBlob(blob, filename);
        }
        else{
            var elem = window.document.createElement('a');
            elem.href = window.URL.createObjectURL(blob);
            elem.download = filename;
            document.body.appendChild(elem);
            elem.click();
            document.body.removeChild(elem);
        }
    }

    let DownloadImage = function() {
        if (checkForGraph()) return null;
        let image = cy.png();
        window.open(image,'Image','width=largeImage.stylewidth,height=largeImage.style.height,resizable=1');
    }

    function createNodeEdgeSets(r) {
        window.parsed_nodes = {"Protein": [],
            "Drug Candidate": [],
            "Drug": [],
            "Pathway": [],
            "Disease": [],
            "Interpro": [],
            "GeneOntology": [],
            "Phenotype": [],
            "Gene": []}; // {<node_label>: [<nodes>]} (Will be used for filtering)
        window.parsed_nodes_data = {}; // {<node_id>: <node_info>} (Will be used for access)
        window.parsed_edges = {}; // {<edge_id>: <edge_info>}
        window.activity_info = {}; // {<protein_id>: [<compound_nodes>]}
        const r_elements = r;
        for(var i=0; i<r_elements.length; i++) {
            if (r_elements[i].data.type == "node") {
                // Element is a node
                var node = r_elements[i].data;
                parsed_nodes_data[node.id] = node;
                parsed_nodes[node.label].push(node);
            }
            else {
                // Element is an edge (Edges are always after nodes in JSON)
                parsed_edges[r_elements[i].data.id] = r_elements[i].data;
                if(r_elements[i].data.relation_type == "ACTIVITY") {
                    var srcId = r_elements[i].data.source;
                    var trgId = r_elements[i].data.target;
                    var src = parsed_nodes_data[srcId];
                    var trg = parsed_nodes_data[trgId];

                    if(src.label == "Protein" && trg.label == "Drug Candidate") {
                        if (!(srcId in activity_info)) {
                            // Key does not exist
                            activity_info[srcId] = [];
                        }
                        activity_info[srcId].push(trg);
                    } else if (trg.label == "Protein" && src.label == "Drug Candidate") {
                        if (!(trgId in activity_info)) {
                            // Key does not exist
                            activity_info[trgId] = [];
                        }
                        activity_info[trgId].push(src);
                    }
                }
            }
        }
        console.log("Created node and edge sets");
        sortNodes();
        console.log("Sorted nodes");
    }

    function sortNodes() {
        for (var key in parsed_nodes) {
            // No need to sort Drug Candidates and Proteins.
            if (key != "Drug Candidate" && key != "Protein") {
                parsed_nodes[key].sort(compareNodes);
            }
        }
        for (var key in activity_info) {
            activity_info[key].sort(compareNodes);
        }
    }

    function compareNodes(ele1, ele2) {
        return ele2.score - ele1.score;
    }

    function filterGraphNew() {
        var nodesToShow = new Set();
        var counts = {"Drug": 0,
            "Pathway": 0,
            "Gene": 0,
            "Disease": 0,
            "Phenotype": 0,
            "Interpro": 0,
            "GeneOntology": 0};
        clearFilteredElements();
        var pValueThreshold = document.getElementById("pvalue").value;
        var noOfCompoundsPerProtein = document.getElementById("topvalue").value;
        console.log(parsed_nodes);
        for(var key in parsed_nodes) {
            // Filter every node except Drug Candidates.
            // Protein filtering was done in back-end.
            if (key != "Drug Candidate" && key != "Protein") {
                var currentList = parsed_nodes[key];
                var currentIndex = 0;
                while (counts[key] < MAX_COUNTS[key] && currentIndex < currentList.length) {
                    var ele = currentList[currentIndex];
                    if (ele.p_value < pValueThreshold) {
                        addFilteredElement(ele);
                        counts[key]++;
                    }
                    currentIndex++;
                }
            }
            else if (key == "Protein") {
                var currentList = parsed_nodes[key];
                for (var i=0; i<currentList.length; i++) {
                    addFilteredElement(currentList[i]);
                }
            }
        }
        console.log("Filtered nodes");
        // Filter drug candidates
        for(var key in activity_info) {
            var currentList = activity_info[key];
            var count = 0;
            var currentIndex = 0;
            while (count < noOfCompoundsPerProtein && currentIndex < currentList.length) {
                var ele = currentList[currentIndex];
                if (ele.p_value < pValueThreshold) {
                    addFilteredElement(ele);
                    count++;
                }
                currentIndex++;
            }
        }
        console.log("Filtered candidates");
        // Filter edges
        for(var edgeId in parsed_edges) {
            var edge = parsed_edges[edgeId];
            if (filteredNodeSet.has(edge.source) && filteredNodeSet.has(edge.target)) {
                addFilteredElement(edge);
            }
        }
        console.log("Filtered edges");
        cy.elements().remove();
        cy.add(filteredElements.elements);
        console.log(filteredNodeSet);
    }

    function showHide() {
        console.log(window.current);
        document.getElementById(window.current).style.display = "none";
        window.current = document.getElementById("nodeTypeBox").value;
        document.getElementById(window.current).style.display = "block";
    }

    function revertFiltering() {
        cy.elements().remove();
        cy.add(els);
        RunLayout(cy);
    }


    function GetNode() {
        activateLoader();
        const searchDepth = document.getElementById("searchDepth");
        const selectedDepth = searchDepth.options[searchDepth.selectedIndex].value;
        const nodeType = document.getElementById("nodeTypeBox");
        const selectedNodeType = nodeType.value;
        const selectedField = document.getElementById(selectedNodeType).value;
        document.getElementById("getnode").disabled = true;
        document.getElementById("searchDepth").disabled = true;

        let address = base_address;
        var client = new HttpClient();

        if (selectedDepth == 1) {
            address = address + "search/?key=" + document.getElementById("nodeKeyText").value + "&type=" + selectedNodeType + "&field=" + selectedField + "&enrichment=true";
            console.log(address);
        }
        else {
            address = address + "search/?key=" + document.getElementById("nodeKeyText").value + "&type=" + selectedNodeType + "&depth=" + selectedDepth + "&field=" + selectedField + "&enrichment=true";
            console.log(address);
        }
        client.get(address, function (response) {
            hideLoader();
            CreateGraph(response);
        }, function (response) {
            hideLoader();
            document.getElementById("searchDepth").disabled = false;
            document.getElementById("getnode").disabled = false;
            alert(response.split(':')[1]);
        });
    }

    let activateLoader = function() {
        let loader = document.getElementById("loader");
        loader.style.visibility = "visible";
    }

    let hideLoader = function() {
        let loader = document.getElementById("loader");
        loader.style.visibility = "hidden";
    }

    let CreateGraph = function (response) {
        // do something with response
        /*console.log("RESPONSE");
        console.log(response);
        const response_parsed = JSON.parse(response.slice(13, -1));
        console.log("PARSED RESPONSE");
        console.log(response_parsed);
        createNodeEdgeSets(response_parsed);
        if(response_parsed.length == 0){
            document.getElementById("getnode").disabled = false;
            alert("The query result is empty! Make sure you have searched with correct paramaters");
            return false;
        }
        window.els = response_parsed;
        if (flag == true) {
            cy.unmount();
            cy.destroy();
        }*/

        try {
            window.cy = cytoscape({
                container: undefined,
                elements: null,
                style: [
                    {
                    selector: 'node',
                    style: {
                        "content": "data(label)",
                        'shape': 'triangle',
                        'background-color': 'red',
                        "font-size": "12px",
                        "text-valign": "center",
                        "text-halign": "center",
                        "background-color": "#555",
                        "text-outline-color": "#555",
                        "text-outline-width": "2px",
                        "color": "#fff",
                        "overlay-padding": "6px",
                        "z-index": "10"
                    }
                    },
                    {
                        selector: 'node[label="Drug"]',
                        style: {
                            "content": "data(display_name)",
                            'shape': 'hexagon',
                            'background-color': 'red'
                        }
                    },
                    {
                        selector: 'node[label="Protein"]',
                        style: {
                            "content": "data(display_name)",
                            "shape": "ellipse",
                            'background-color': 'blue'
                        }
                    },
                    {
                        selector: 'node[label="Gene"]',
                        style: {
                            "content": "data(display_name)",
                            "shape": "diamond",
                            'background-color': '#2b580c'
                        }
                    },
                    {
                        selector: 'node[label="Disease"]',
                        style: {
                            "content": "data(display_name)",
                            'shape': 'triangle',
                            'background-color': 'orange'
                        }
                    },
                    {
                        selector: 'node[label="Phenotype"]',
                        style: {
                            "content": "data(display_name)",
                            'shape': 'tag',
                            'background-color': '#639a67'
                        }
                    },
                    {
                        selector: 'node[label="Drug Candidate"]',
                        style: {
                            "content": "data(display_name)",
                            'shape': 'square',
                            'background-color': 'purple',
                        }
                    },
                    {
                        selector: 'node[label="Pathway"]',
                        style: {
                            "content": "data(display_name)",
                            'shape': 'rhomboid',
                            'background-color': 'yellow',
                        }
                    },
                    {
                        selector: 'node[label="Interpro"]',
                        style: {
                            "content": "data(display_name)",
                            'shape': 'octagon',
                            'background-color': '#000839',
                        }
                    },
                    {
                        selector: 'node[label="GeneOntology"]',
                        style: {
                            "content": "data(display_name)",
                            'shape': 'vee',
                            'background-color': '#d9bf77',
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'content': function (ele)
                            {
                                return cy.edges('[source = "' + ele.data("source") + '"][target = "' + ele.data("target") + '"]').length;
                            },
                            'width': 3,
                            'opacity': 0.5,
                            'line-color': '#4287f5'
                        }
                    },
                    {
                        selector: ':loop',
                        style: {
                            "curve-style": 'bezier',
                            "control-point-step-size": 22,
                            'width': 3,
                            'opacity': 0.5,
                            'line-color': '#03fcf8'
                        }
                    }
                ]
            });
        } catch (e) {
            console.log("ERROR: " + e);
            console.log(response);
            return;
        }
        const searchDepth = document.getElementById("searchDepth");
        const selectedDepth = searchDepth.options[searchDepth.selectedIndex].value;
        if (selectedDepth != 1) {
            start = new Date().getTime();
            filterGraphNew();
            end = new Date().getTime();
            console.log("Filter time:" + (end-start)/1000);
            document.getElementById("filter").disabled = false;
            //cy.add(window.els);
        } else {
            cy.add([{"data": {"type": "node", "id": 371666, "chains": [{'description': 'B2 bradykinin receptor', 'begin_floor:short': '1', 'begin_ceil:short': '2', 'begin_unparsed:short': '1', 'begin_uncertain:bool': 'False', 'end_floor:short': '396', 'end_ceil:short': '397', 'end_unparsed:short': '396', 'end_uncertain:bool': 'False'}, {"test" : "a"}], "genes": ["['Bdkrb2']"], "chromosome": "Unplaced", "mass": 44930, "name": "B2 bradykinin receptor", "length": 396, "accession": "P25023", "display_name": "P25023", "n_total_enrichment_connections": 0, "tax_id": "10116", "label": "Protein", "labels": ["Protein"]}}]);
        }
        document.getElementById("searchDepth").disabled = false;
        //document.getElementById("revert").disabled = false;
        flag = true;
        document.getElementById("getnode").disabled = false;
        cy.mount(document.getElementById('cy'));

        //set and highlight searched node
        cy.nodes().slice(0,1).style({'shape' : 'star',  "text-outline-color": 'red'});
        //save style for later recovery
        var styleJson = cy.style().json();

        cy.cxtmenu({
            selector: 'node',

            commands: [
                {
                    content: 'Remove',
                    select: function(ele){
                        ele.remove();
                    }
                },
                {
                    content: 'Remove with dependents',
                    select: function(ele){

                        var childs = ele.neighborhood(function( child ){
                            return child.neighborhood().nodes().length == 1;//removes nodes that are only connected to ele even if there is multipl econnections
                        });

                        cy.remove(childs);

                        ele.remove();
                    }
                },
                {
                    content: 'Go to website',
                    select: function(ele){
                        //const node = ele.target;
                        console.log(ele.data("label"));
                        if(ele.data("label")=='Drug')
                        {
                            window.open("https://www.drugbank.ca/"+ele.data("drugbank_drug_id"), '_blank');
                        }
                        else if(ele.data("label")=='Protein')
                        {
                            window.open("https://www.uniprot.org/uniprot/"+ele.data("accession"), '_blank');
                        }
                        else if(ele.data("label")=='Drug Candidate')
                        {
                            window.open("https://www.ebi.ac.uk/chembldb/compound/inspect/"+ele.data("molecule_chembl_id"), '_blank');
                        }
                        else if(ele.data("label")=='Pathway')
                        {
                            window.open("https://reactome.org/content/detail/"+ ele.data("reactome_id").toLowerCase(), '_blank');
                        }
                    }
                }
            ]
        });
        cy.cxtmenu({
            selector: 'core',

            commands: [
                {
                    content: 'Remove 0 degree nodes',
                    select: function(){
                        var elements=cy.filter(function(element, i){
                            return element.isNode() && element.degree()==0;
                        });
                        cy.remove(elements);
                    }
                }
            ]
        });
        cy.on('click', 'node', function (evt) {
            //highlight the node
            var targetNode = evt.target;
            cy.style(styleJson);
            cy.style().selector('edge').style({'content': function (ele)
                {
                    return cy.edges('[source = "' + ele.data("source") + '"][target = "' + ele.data("target") + '"]').length;
                }
            });
            cy.style().selector(targetNode).style({'background-color' : 'magenta' }).update();

            ClearLeftSideBar();
            leftSideBarTabCount=1;
            data = this.data();
            let type = data["label"];
            CreateLeftSideBarTab(0,type);


            var table = document.getElementById("detailsTable0");
            for (var key in data) {
                let cross_ref_flag = false;
                let row_data = "";
                if (key != "type" && key != "id" && key != "label" && key != "display_name") {
                    switch (type) {
                        case "Drug":
                            if(key == "xref_pubchem") {
                                cross_ref_flag = true;
                                const cross_refs = data[key];
                                for (cross_ref in cross_refs) {
                                    const sid = cross_refs[0].split(":")[1].slice(1,);
                                    row_data += "<a href='https://pubchem.ncbi.nlm.nih.gov/substances/"+sid+"'target='_blank'>"+sid+"</a>, ";
                                }
                            } else if(key == "molecule_chembl_id") {
                                cross_ref_flag = true;
                                const ref = data[key];
                                row_data += "<a href='https://www.ebi.ac.uk/chembl/compound_report_card/"+ref+"'target='_blank'>"+ref+"</a> ";
                            } else if(key == "kegg_cid") {
                                cross_ref_flag = true;
                                const ref = data[key];
                                row_data += "<a href='https://www.genome.jp/dbget-bin/www_bget?cpd:"+ref+"'target='_blank'>"+ref+"</a> ";
                            } else if(key == "pubchem_sid") {
                                cross_ref_flag = true;
                                const ref = data[key];
                                row_data += "<a href='https://pubchem.ncbi.nlm.nih.gov/substances/"+ref+"'target='_blank'>"+ref+"</a> ";
                            } else if(key == "pubchem_cid") {
                                cross_ref_flag = true;
                                const ref = data[key];
                                row_data += "<a href='https://pubchem.ncbi.nlm.nih.gov/compounds/"+ref+"'target='_blank'>"+ref+"</a> ";
                            }
                        case "Drug Candidate":
                            if(key == "xref_pubchem") {
                                cross_ref_flag = true;
                                const cross_refs = data[key];
                                for (cross_ref in cross_refs) {
                                    const sid = cross_refs[0].split(":")[1].slice(1,);
                                    row_data += "<a href='https://pubchem.ncbi.nlm.nih.gov/substances/"+sid+"'target='_blank'>"+sid+"</a>, ";
                                }
                            }
                        case "Disease" :
                            if(key == "doid") {
                                cross_ref_flag = true;
                                const cross_refs = data[key];
                                for (cross_ref in cross_refs) {
                                    const sid = cross_refs[0].split(":")[1].slice(1,);
                                    row_data += "<a href='https://www.ebi.ac.uk/ols/ontologies/doid/terms?iri=http%3A%2F%2Fpurl.obolibrary.org%2Fobo%2FDOID_0"+sid+"'target='_blank'>"+sid+"</a>, ";
                                }
                            }
                    }
                    //protein needs extra tables
                    if(type == "Protein" &&
                        (key == "active_sites" || key == "binding_sites" || key == "domains" || key =="top_doms" || key == "mutagens" || key == "variants" || key == "chains"))
                    {
                        // 'active_sites' : [{'extraKey': .., 'extraKey2': ...},{'extraKey' : ...}]
                        var extraData = data[key];
                        console.log(extraData);
                        for (var extraDataElement in extraData)
                        {
                            console.log("extra data elemenet:");
                            console.log(extraDataElement);
                            console.log("extradata[extradataelement]");
                            console.log(extraData[extraDataElement]);
                            console.log(typeof(extraData[extraDataElement]));
                            //console.log(JSON.parse(extraData[extraDataElement]));
                            CreateLeftSideBarTab(leftSideBarTabCount,key);
                            for(var extraKey in extraData[extraDataElement])
                            {
                                var extraTable = document.getElementById("detailsTable" + leftSideBarTabCount);
                                var extraRow = extraTable.insertRow(0);
                                extraRow.innerHTML = "<th>" + extraKey + "</th>";
                                var extraCell1 = extraRow.insertCell(-1);// 0 will put columns in reverse order for some reason
                               // console.log(extraData);
                                //console.log( JSON.parse(extraData[extraDataElement])["description"]);
                                console.log("----");
                                extraCell1.innerText = extraData[extraDataElement][extraKey];
                            }
                            leftSideBarTabCount++;
                        }
                    }
                    var row = table.insertRow(0);
                    row.innerHTML = "<th>" + key + "</th>";
                    var cell1 = row.insertCell(-1); // 0 will put columns in reverse order for some reason
                    if(cross_ref_flag) cell1.innerHTML = row_data;
                    else cell1.innerText = data[key];
                }
            }
            leftSideBarTabs.tabs( "refresh" );
        });
        cy.on('click', 'edge', function (evt) {
            //highlight the edge
            var targetEdge = evt.target;
            cy.style(styleJson);
            cy.style().selector('edge').style({'content': function (ele)
                {
                    return cy.edges('[source = "' + ele.data("source") + '"][target = "' + ele.data("target") + '"]').length;
                }
            });
            cy.style().selector(targetEdge).style({'line-color' : 'magenta' }).update();

            //find other edges between source and target nodes
            var source = targetEdge.data().source;
            var target = targetEdge.data().target;
            var edgesBetween = cy.edges('[source = "' + source + '"][target = "' + target + '"]');
            ClearLeftSideBar();
            leftSideBarTabCount=edgesBetween.length;

            for(let edgeIndex = 0; edgeIndex < leftSideBarTabCount ; edgeIndex++)
            {
                CreateLeftSideBarTab(edgeIndex,"");

                data = edgesBetween[edgeIndex].data();
                var table = document.getElementById("detailsTable"+edgeIndex);
                for (var key in data) {
                    if (key != "type" && key != "id") {
                        var row = table.insertRow(0);
                        row.innerHTML = "<th>" + key + "</th>";
                        var cell1 = row.insertCell(-1); // 0 will put columns in reverse order for some reason
                        cell1.innerText = data[key];
                    }
                }
            }

            leftSideBarTabs.tabs( "refresh" );
        });
        console.log(JSON.parse(response.slice(13, -1)));
        RunLayout(cy);
    }
    CreateGraph("");

    function ExecuteQuery() {
        activateLoader();
        let address = base_address + "search/cypher?q=";
        var client = new HttpClient();
        client.get(address + document.getElementById("queryText").value, function (response) {
            hideLoader();
            CreateGraph(response)
        }, function (response) {
            hideLoader();
            alert(response.split(':')[1]);
        });
    }

    function ClearLeftSideBar()
    {
        //delete previously created tabs
        for(let tabIndex = 0 ; tabIndex < leftSideBarTabCount; tabIndex++)
        {
            let panelId = leftSideBarTabs.find( ".ui-tabs-tab" ).remove().attr( "aria-controls" );
            $( "#" + panelId ).remove();
            leftSideBarTabs.tabs( "refresh" );
        }
    }

    function CreateLeftSideBarTab(tabIndex, nodeType)
    {
        //create a new tab div  containing new table
        let detailsTableDiv = document.createElement('table');
        detailsTableDiv.id = "detailsTable" + tabIndex;
        detailsTableDiv.classList.add("paleBlueRows");
        detailsTableDiv.style.tableLayout="fixed";
        detailsTableDiv.style.width = "107%";
        detailsTableDiv.innerHTML = "<tbody></tbody>";

        let scrollDiv = document.createElement('div');
        scrollDiv.id="leftTabs" + tabIndex;
        scrollDiv.classList.add("table-scroll");
        scrollDiv.append(detailsTableDiv);
        var li="";
        if(nodeType!="")
        {
            li = $( tabTemplate.replace( /#\{href\}/g, "#" + "leftTabs"+tabIndex ).replace( /#\{label\}/g, nodeType ) );
        }
        else
        {
            li = $( tabTemplate.replace( /#\{href\}/g, "#" + "leftTabs"+tabIndex ).replace( /#\{label\}/g, tabIndex+1 ) );
        }
        leftSideBarTabs.find( ".ui-tabs-nav" ).append( li );
        leftSideBarTabs.append( "<div id='leftTabs" + tabIndex + "'>" + scrollDiv.innerHTML + "</div>");
        leftSideBarTabs.tabs( "refresh" );
        leftSideBarTabs.tabs("option", "active", 0);
    }

    /* concentric layout variables */
    var drugCount=0;
    var proteinCount=0;
    var diseaseCount=0;
    var phenotypeCount=0;
    var drugCandidateCount=0;
    var pathwayCount=0;
    var geneCount=0;
    var interproCount=0;
    var geneOntologyCount=0;
    function RunLayout(cy) {
        _layoutSelection = document.getElementById("layoutSelection");
        if (_layoutSelection.options[_layoutSelection.selectedIndex].value == "fcose") {
            var layout = cy.layout({
                name: "fcose",
                nodeRepulsion: true,
                idealEdgeLength: cy.elements.length * 300,
                edgeElasticity: true
            });
            layout.run();
        }
        else if (_layoutSelection.options[_layoutSelection.selectedIndex].value == "circle") {
            var layout = cy.layout({
                name: "circle"
            });
            layout.run();
        }
        else if (_layoutSelection.options[_layoutSelection.selectedIndex].value == "concentric") {

            proteinCount=0;
            pathwayCount=0;
            phenotypeCount=0;
            diseaseCount=0;
            drugCount=0;
            drugCandidateCount=0;
            geneCount=0;
            interproCount=0;
            geneOntologyCount=0;

            var isCenteringHighDegreeNodesDisabled = spinner.spinner( "option", "disabled" );

            var layout = cy.layout({
                //basically typeMultiplier divider * levelWidth is the amount of nodes that can be in 1 circle(eg: proteinCount/->2<-,  levelWidth:->5<-:::: 2*5=10), divider can be unique for each node type
                name: 'concentric',
                concentric: function (node)
                {
                    var typeMultiplier = 1;
                    data = node.data();
                    if(!isCenteringHighDegreeNodesDisabled)
                    {
                        if(node.degree() > spinner.spinner("value") ) return 10000;
                    }
                    for(var key in data)
                    {
                        if(key=="label")
                        {
                            if(data[key]=="Disease")
                            {
                                diseaseCount++;
                                typeMultiplier = 1600 - diseaseCount/2;
                            }
                            else if(data[key]=="Phenotype")
                            {
                                phenotypeCount++;
                                typeMultiplier = 1400 - phenotypeCount/2;
                            }
                            else if(data[key]=="Gene")
                            {
                                geneCount++;
                                typeMultiplier = 1200 - geneCount/2;
                            }
                            else if(data[key]=="Protein")
                            {
                                proteinCount++;
                                typeMultiplier = 1000 - proteinCount/2;
                            }
                            else if(data[key]=="Interpro")
                            {
                                interproCount++;
                                typeMultiplier = 800 - interproCount/2;
                            }
                            else if(data[key]=="GeneOntology")
                            {
                                geneOntologyCount++;
                                typeMultiplier = 600 - geneOntologyCount/2;
                            }
                            else if(data[key]=="Pathway")
                            {
                                pathwayCount++;
                                typeMultiplier = 400 - pathwayCount/2;
                            }
                            else if(data[key]=="Drug")
                            {
                                drugCount++;
                                typeMultiplier = 200 - (drugCandidateCount + drugCount)/2;
                            }
                            else if(data[key]=="Drug Candidate")
                            {
                                drugCandidateCount++;
                                typeMultiplier = 200 - (drugCandidateCount + drugCount)/2;
                            }

                            break;
                        }
                    }
                    return typeMultiplier;
                },
                levelWidth: function (nodes)
                {
                    return nodes.maxDegree()/4;
                },
                equidistant:false,
            });
            layout.run();
        }
        else if (_layoutSelection.options[_layoutSelection.selectedIndex].value == "grid") {
            var layout = cy.layout({
                name: 'grid',
                avoidOverlap: true,
                avoidOverlapPadding: 80
            });
            layout.run();
        }
    }

    var HttpClient = function () {
        this.get = function (aUrl, aCallback, failed_callback, headerName = "", headerValue = "") {
            var anHttpRequest = new XMLHttpRequest();

            anHttpRequest.onreadystatechange = function () {
                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200) {
                    aCallback(anHttpRequest.responseText);
                }
                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 400) {
                    failed_callback(anHttpRequest.responseText);
                }
            }

            anHttpRequest.open("GET", aUrl, true);

            if (headerName != "") {
                anHttpRequest.setRequestHeader(headerName, headerValue);
            }

            anHttpRequest.send(null);
        }
    }


</script>
</body>
</html>
